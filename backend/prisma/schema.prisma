// Prisma Schema for POS System
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MANAGEMENT ====================

enum UserRole {
  ADMIN
  OWNER
  MANAGER
  CASHIER
  WAITER        // Restaurant-specific role
  KITCHEN_STAFF // Restaurant-specific role
  INVENTORY_CLERK
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

model User {
  id            String      @id @default(uuid())
  username      String      @unique
  email         String      @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  role          UserRole    @default(CASHIER)
  status        UserStatus  @default(ACTIVE)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  lastLoginAt   DateTime?

  // Relations
  shifts        Shift[]
  sales         Sale[]
  waiterSales   Sale[]      @relation("SaleWaiter") // Restaurant: sales as waiter
  auditLogs     AuditLog[]

  @@map("users")
}

// ==================== PRODUCT & INVENTORY ====================

model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  parentId    String?
  active      Boolean   @default(true)
  parent      Category? @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryHierarchy")
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("categories")
}

model Product {
  id              String                   @id @default(uuid())
  sku             String                   @unique
  barcode         String?                  @unique
  name            String
  description     String?
  categoryId      String
  category        Category                 @relation(fields: [categoryId], references: [id])
  price           Decimal                  @db.Decimal(10, 2)
  cost            Decimal?                 @db.Decimal(10, 2)
  taxRate         Decimal                  @default(0.10) @db.Decimal(5, 4)
  stock           Int                      @default(0)
  lowStockAlert   Int                      @default(10)
  unit            String                   @default("piece")
  imageUrl        String?
  imageData       Bytes?                   // Store image as blob
  imageMimeType   String?                  // Store image MIME type (image/jpeg, image/png, etc)
  isActive        Boolean                  @default(true)
  createdAt       DateTime                 @default(now())
  updatedAt       DateTime                 @updatedAt

  // Relations
  saleItems       SaleItem[]
  stockMovements  StockMovement[]
  modifierGroups  ProductModifierGroup[]   // Restaurant: modifiers for this product
  kitchenStations ProductKitchenStation[]  // Restaurant: which stations prepare this
  recipe          Recipe?                  // Restaurant: recipe/BOM

  @@map("products")
}

enum MovementType {
  PURCHASE
  SALE
  ADJUSTMENT
  DAMAGE
  RETURN
  TRANSFER
  WASTE         // Restaurant-specific: Food spoilage
  COMP          // Restaurant-specific: Complimentary items
}

model StockMovement {
  id          String        @id @default(uuid())
  productId   String
  product     Product       @relation(fields: [productId], references: [id])
  type        MovementType
  quantity    Int
  notes       String?
  createdAt   DateTime      @default(now())
  createdBy   String

  @@map("stock_movements")
}

// ==================== SALES & TRANSACTIONS ====================

enum OrderType {
  DINE_IN
  TAKEAWAY
  DELIVERY
  DRIVE_THRU
}

enum OrderStatus {
  PENDING       // Order created, not sent to kitchen
  PREPARING     // Sent to kitchen
  READY         // Food ready
  SERVED        // Served to customer (dine-in)
  COMPLETED     // Payment completed
  CANCELLED
}

enum SaleStatus {
  COMPLETED
  REFUNDED
  PARTIALLY_REFUNDED
  VOIDED
}

enum PaymentMethod {
  CASH
  CARD
  MOBILE_WALLET
  STORE_CREDIT
  SPLIT
}

model Sale {
  id              String        @id @default(uuid())
  saleNumber      String        @unique
  customerId      String?
  customer        Customer?     @relation(fields: [customerId], references: [id])
  cashierId       String
  cashier         User          @relation(fields: [cashierId], references: [id], map: "sale_cashier_fk")
  waiterId        String?       // Restaurant: waiter who took order
  waiter          User?         @relation("SaleWaiter", fields: [waiterId], references: [id])
  shiftId         String?
  shift           Shift?        @relation(fields: [shiftId], references: [id])
  tableId         String?       // Restaurant: table assignment
  table           Table?        @relation(fields: [tableId], references: [id])
  orderType       OrderType     @default(DINE_IN) // Restaurant: order type
  orderStatus     OrderStatus   @default(PENDING) // Restaurant: order status
  subtotal        Decimal       @db.Decimal(10, 2)
  taxAmount       Decimal       @db.Decimal(10, 2)
  serviceCharge   Decimal       @default(0) @db.Decimal(10, 2) // Restaurant: auto service %
  discountAmount  Decimal       @default(0) @db.Decimal(10, 2)
  tipAmount       Decimal       @default(0) @db.Decimal(10, 2) // Restaurant: tips
  totalAmount     Decimal       @db.Decimal(10, 2)
  paymentMethod   PaymentMethod
  cashReceived    Decimal?      @db.Decimal(10, 2)
  changeGiven     Decimal?      @db.Decimal(10, 2)
  status          SaleStatus    @default(COMPLETED)
  notes           String?
  deliveryAddress String?       // Restaurant: for delivery orders
  deliveryFee     Decimal       @default(0) @db.Decimal(10, 2) // Restaurant: delivery fee
  estimatedTime   DateTime?     // Restaurant: estimated ready/delivery time
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  items           SaleItem[]
  refunds         Refund[]
  payments        SalePayment[]

  @@map("sales")
}

model SalePayment {
  id              String        @id @default(uuid())
  saleId          String
  sale            Sale          @relation(fields: [saleId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod
  amount          Decimal       @db.Decimal(10, 2)
  createdAt       DateTime      @default(now())

  @@map("sale_payments")
}

model SaleItem {
  id          String             @id @default(uuid())
  saleId      String
  sale        Sale               @relation(fields: [saleId], references: [id], onDelete: Cascade)
  productId   String
  product     Product            @relation(fields: [productId], references: [id])
  quantity    Int
  unitPrice   Decimal            @db.Decimal(10, 2)
  taxRate     Decimal            @db.Decimal(5, 4)
  discount    Decimal            @default(0) @db.Decimal(10, 2)
  totalPrice  Decimal            @db.Decimal(10, 2)
  courseType  String?            // Restaurant: STARTER, MAIN, DESSERT
  notes       String?            // Restaurant: special instructions
  sentToKitchenAt DateTime?      // Restaurant: when sent to kitchen
  readyAt     DateTime?          // Restaurant: when marked ready

  // Relations
  modifiers   SaleItemModifier[] // Restaurant: customizations

  @@map("sale_items")
}

model Refund {
  id          String   @id @default(uuid())
  saleId      String
  sale        Sale     @relation(fields: [saleId], references: [id])
  amount      Decimal  @db.Decimal(10, 2)
  reason      String
  approvedBy  String?
  createdAt   DateTime @default(now())

  @@map("refunds")
}

// ==================== CUSTOMER MANAGEMENT ====================

model Customer {
  id              String    @id @default(uuid())
  firstName       String
  lastName        String
  email           String?   @unique
  phone           String?   @unique
  loyaltyPoints   Int       @default(0)
  storeCredit     Decimal   @default(0) @db.Decimal(10, 2)
  totalSpent      Decimal   @default(0) @db.Decimal(10, 2)
  visitCount      Int       @default(0)
  lastVisit       DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  sales           Sale[]

  @@map("customers")
}

// ==================== SHIFT MANAGEMENT ====================

enum ShiftStatus {
  OPEN
  CLOSED
  RECONCILED
}

model Shift {
  id                String      @id @default(uuid())
  shiftNumber       String      @unique
  cashierId         String
  cashier           User        @relation(fields: [cashierId], references: [id])
  startingCash      Decimal     @db.Decimal(10, 2)
  endingCash        Decimal?    @db.Decimal(10, 2)
  expectedCash      Decimal?    @db.Decimal(10, 2)
  discrepancy       Decimal?    @db.Decimal(10, 2)
  totalSales        Decimal     @default(0) @db.Decimal(10, 2)
  totalTransactions Int         @default(0)
  status            ShiftStatus @default(OPEN)
  openedAt          DateTime    @default(now())
  closedAt          DateTime?
  notes             String?

  // Relations
  sales             Sale[]

  @@map("shifts")
}

// ==================== AUDIT LOG ====================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  SALE
  REFUND
  VOID
  SHIFT_OPEN
  SHIFT_CLOSE
}

model AuditLog {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  action      AuditAction
  entity      String
  entityId    String?
  changes     Json?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime    @default(now())

  @@map("audit_logs")
}

// ==================== SYSTEM SETTINGS ====================

model Setting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  category  String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

// ==================== RESTAURANT-SPECIFIC FEATURES ====================

// Table Management
enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
  CLEANING
}

model Floor {
  id          String   @id @default(uuid())
  name        String
  description String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tables      Table[]

  @@map("floors")
}

model Table {
  id          String      @id @default(uuid())
  floorId     String
  floor       Floor       @relation(fields: [floorId], references: [id])
  tableNumber String
  capacity    Int
  status      TableStatus @default(AVAILABLE)
  positionX   Int?        // For floor plan designer
  positionY   Int?        // For floor plan designer
  shape       String?     // CIRCLE, SQUARE, RECTANGLE for UI
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Relations
  sales       Sale[]

  @@unique([floorId, tableNumber])
  @@map("tables")
}

// Product Modifiers
model ModifierGroup {
  id              String     @id @default(uuid())
  name            String
  description     String?
  isRequired      Boolean    @default(false) // Must select at least one
  minSelection    Int        @default(0)
  maxSelection    Int?       // NULL = unlimited
  sortOrder       Int        @default(0)
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  modifiers       Modifier[]
  products        ProductModifierGroup[]

  @@map("modifier_groups")
}

model Modifier {
  id              String       @id @default(uuid())
  groupId         String
  group           ModifierGroup @relation(fields: [groupId], references: [id], onDelete: Cascade)
  name            String
  priceAdjustment Decimal      @default(0) @db.Decimal(10, 2) // + or - from base price
  isDefault       Boolean      @default(false)
  sortOrder       Int          @default(0)
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // Relations
  saleItems       SaleItemModifier[]

  @@map("modifiers")
}

model ProductModifierGroup {
  id              String         @id @default(uuid())
  productId       String
  product         Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  modifierGroupId String
  modifierGroup   ModifierGroup  @relation(fields: [modifierGroupId], references: [id], onDelete: Cascade)
  createdAt       DateTime       @default(now())

  @@unique([productId, modifierGroupId])
  @@map("product_modifier_groups")
}

model SaleItemModifier {
  id          String     @id @default(uuid())
  saleItemId  String
  saleItem    SaleItem   @relation(fields: [saleItemId], references: [id], onDelete: Cascade)
  modifierId  String
  modifier    Modifier   @relation(fields: [modifierId], references: [id])
  quantity    Int        @default(1)
  price       Decimal    @db.Decimal(10, 2) // Stored price at time of sale

  @@map("sale_item_modifiers")
}

// Recipe & BOM (Bill of Materials)
model Ingredient {
  id            String   @id @default(uuid())
  name          String   @unique
  unit          String   // kg, liter, piece, etc.
  cost          Decimal  @db.Decimal(10, 2)
  stock         Decimal  @default(0) @db.Decimal(10, 3) // Allow decimals
  lowStockAlert Decimal  @default(0) @db.Decimal(10, 3)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  recipeItems   RecipeItem[]

  @@map("ingredients")
}

model Recipe {
  id          String   @id @default(uuid())
  productId   String   @unique
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  description String?
  prepTime    Int?     // Minutes
  cookTime    Int?     // Minutes
  servings    Int      @default(1)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  items       RecipeItem[]

  @@map("recipes")
}

model RecipeItem {
  id           String     @id @default(uuid())
  recipeId     String
  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredientId String
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id])
  quantity     Decimal    @db.Decimal(10, 3) // Amount needed
  unit         String     // Must match ingredient unit
  notes        String?

  @@map("recipe_items")
}

// Kitchen Display System
enum KitchenTicketStatus {
  NEW
  IN_PROGRESS
  READY
  SERVED
  CANCELLED
}

model KitchenStation {
  id          String   @id @default(uuid())
  name        String   @unique // Grill, Bar, Pastry, etc.
  description String?
  printerIp   String?  // IP address for station printer (e.g., 192.168.1.10)
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tickets     KitchenTicket[]
  products    ProductKitchenStation[]

  @@map("kitchen_stations")
}

model ProductKitchenStation {
  id               String         @id @default(uuid())
  productId        String
  product          Product        @relation(fields: [productId], references: [id], onDelete: Cascade)
  kitchenStationId String
  kitchenStation   KitchenStation @relation(fields: [kitchenStationId], references: [id], onDelete: Cascade)

  @@unique([productId, kitchenStationId])
  @@map("product_kitchen_stations")
}

model KitchenTicket {
  id               String              @id @default(uuid())
  saleId           String
  saleItemId       String
  kitchenStationId String
  kitchenStation   KitchenStation      @relation(fields: [kitchenStationId], references: [id])
  status           KitchenTicketStatus @default(NEW)
  priority         Int                 @default(0) // Higher = more urgent
  createdAt        DateTime            @default(now())
  startedAt        DateTime?
  completedAt      DateTime?
  notes            String?

  @@map("kitchen_tickets")
}
