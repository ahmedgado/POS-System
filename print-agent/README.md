# POS Print Agent

ğŸ–¨ï¸ **Local print agent for cloud/on-premise POS system**

This agent runs on a local computer in your restaurant and handles printing to network printers (both thermal ESC/POS printers and regular PDF printers).

## Features

- âœ… **Cross-platform** - Works on Windows, Mac, and Linux
- âœ… **Thermal Printers** - ESC/POS protocol support
- âœ… **Regular Printers** - PDF printing to network printers
- âœ… **Auto-retry** - Automatic retry on failures
- âœ… **Cloud Compatible** - Works with cloud-hosted backends
- âœ… **Real-time** - Polls every 3 seconds for new jobs

## Requirements

- Node.js 16+ installed
- Network access to printers
- Network access to backend server

## Installation

### 1. Install Dependencies

```bash
cd print-agent
npm install
```

### 2. Configure

Copy the example environment file:

```bash
cp .env.example .env
```

Edit `.env` with your settings:

```env
# For cloud deployment
BACKEND_URL=https://your-pos-backend.com

# For on-premise deployment
BACKEND_URL=http://192.168.1.100:3000

# Get API token from your backend admin panel
API_TOKEN=your-api-token-here

# Unique ID for this agent
AGENT_ID=restaurant-main-agent

# Poll every 3 seconds
POLL_INTERVAL=3000
```

### 3. Get API Key
   
Instead of using a temporary login token, use a permanent API Key:

Run this command in your main project folder:
```bash
docker compose exec -u root backend node generate-api-key.js "My Agent"
```

Copy the key (starts with `pk_live_...`) to your `.env` file.

## Usage

### Start the Agent

```bash
npm start
```

### Run in Development Mode (with auto-restart)

```bash
npm run dev
```

### Run as Background Service

#### Windows (using PM2)

```bash
npm install -g pm2
pm2 start index.js --name pos-print-agent
pm2 save
pm2 startup
```

#### Linux/Mac (using PM2)

```bash
npm install -g pm2
pm2 start index.js --name pos-print-agent
pm2 save
pm2 startup
```

#### Windows (using NSSM)

1. Download NSSM from https://nssm.cc/download
2. Run: `nssm install POSPrintAgent`
3. Set path to `node.exe` and arguments to full path of `index.js`
4. Start the service

## Printer Configuration

### Thermal Printers (ESC/POS)

- Default port: `9100`
- Protocol: ESC/POS
- Configure printer IP in Kitchen Stations settings
- Example: `192.168.1.10`

### Regular Network Printers (PDF)

- Requires printer to be installed in OS
- Use printer name from system, not IP
- PDF is generated by backend
- Agent downloads and prints

## Troubleshooting

### Agent Can't Connect to Backend

```
âŒ Network Error: Cannot reach backend
```

**Solution:**
- Check `BACKEND_URL` in `.env`
- Ensure backend is running
- Check firewall settings
- Verify network connectivity

### Can't Connect to Printer

```
âŒ Failed to connect to printer at 192.168.1.10
```

**Solution:**
- Verify printer IP address
- Check printer is powered on
- Ping the printer: `ping 192.168.1.10`
- Ensure printer port 9100 is open
- Check network/firewall settings

### Authentication Failed

```
âŒ API Error: 401 - Unauthorized
```

**Solution:**
- Check `API_TOKEN` in `.env`
- Regenerate token in backend admin panel
- Ensure token hasn't expired

### Printer Prints Garbage

**Solution:**
- Verify printer supports ESC/POS
- Check printer encoding settings
- Try different printer model in code

## Logs

The agent outputs logs to console:

- `ğŸ“¥ Found X pending job(s)` - Jobs detected
- `ğŸ“„ Processing job...` - Job started
- `âœ… Job completed successfully` - Success
- `âŒ Job failed` - Error occurred

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     CLOUD/ON-PREMISE BACKEND         â”‚
â”‚  - Stores print jobs in database    â”‚
â”‚  - Provides API endpoints            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ HTTPS
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      PRINT AGENT (This App)          â”‚
â”‚  - Polls backend every 3 seconds    â”‚
â”‚  - Fetches pending jobs             â”‚
â”‚  - Prints to local printers         â”‚
â”‚  - Updates job status               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ Local Network
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       NETWORK PRINTERS               â”‚
â”‚  - Thermal: 192.168.1.10:9100       â”‚
â”‚  - Regular: System printer name     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security

- Uses API token authentication
- HTTPS recommended for cloud deployments
- Tokens can be revoked in backend
- Agent ID tracks which agent printed what

## Support

For issues or questions:
1. Check logs for error messages
2. Verify network connectivity
3. Test printer manually
4. Check backend API is accessible

## License

MIT
